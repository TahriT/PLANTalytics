<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLANTalytics - Visual Explorer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2d5016;
            --secondary-color: #6b9e3e;
            --accent-color: #9ec472;
            --dark-bg: #1a1a1a;
            --light-bg: #f5f5f5;
            --text-dark: #333;
            --text-light: #fff;
            --zone-cold: #3498db;
            --zone-hot: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-light);
            padding: 0.75rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 10;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .header-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: background 0.3s;
            font-size: 0.9rem;
        }

        .header-link:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 340px;
            background: white;
            padding: 1.5rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 5;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-header {
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 700;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Visual Filters */
        .filter-card {
            background: #fff;
            border-radius: 8px;
        }

        .filter-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #555;
            display: flex;
            justify-content: space-between;
        }

        /* Zone Selector */
        .zone-selector {
            display: flex;
            height: 40px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .zone-segment {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            font-weight: bold;
            transition: all 0.2s;
            position: relative;
        }

        .zone-segment:hover {
            transform: scaleY(1.1);
            z-index: 2;
        }

        .zone-segment.active {
            box-shadow: inset 0 0 0 2px white;
            transform: scaleY(1.15);
            z-index: 3;
            font-size: 0.9rem;
        }

        .zone-segment.dimmed {
            opacity: 0.3;
        }

        /* Range Slider */
        .range-container {
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .range-track {
            position: absolute;
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
        }

        .range-fill {
            position: absolute;
            height: 6px;
            background: var(--secondary-color);
            border-radius: 3px;
        }

        .range-input {
            position: absolute;
            width: 100%;
            height: 6px;
            background: none;
            pointer-events: none;
            -webkit-appearance: none;
            z-index: 2;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-top: -6px; /* Adjust for track height */
        }
        
        /* Firefox support */
        .range-input::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        /* Standard Inputs */
        select, input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        select:focus, input[type="text"]:focus {
            border-color: var(--secondary-color);
            outline: none;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-val {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-lbl {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }

        /* Visualization Area */
        .viz-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: #eef1e8;
            overflow: hidden;
        }

        #spiralContainer {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }

        #spiralContainer:active {
            cursor: grabbing;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            pointer-events: none;
            font-size: 0.9rem;
            z-index: 1000;
            max-width: 280px;
            opacity: 0;
            transition: opacity 0.2s;
            border-left: 4px solid var(--primary-color);
        }

        .tooltip h4 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        /* List View */
        .list-toggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            font-weight: bold;
            color: var(--primary-color);
            z-index: 50;
            transition: transform 0.2s;
        }

        .list-toggle:hover {
            transform: translateY(-2px);
        }

        .list-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 350px;
            background: white;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 40;
            display: flex;
            flex-direction: column;
        }

        .list-panel.open {
            transform: translateY(0);
        }

        .list-header {
            padding: 1rem 2rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9f9f9;
        }

        .list-content {
            flex: 1;
            overflow: auto;
            padding: 0 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            position: sticky;
            top: 0;
            background: white;
            font-weight: 600;
            color: var(--primary-color);
        }

        tr:hover {
            background-color: #f0f7eb;
            cursor: pointer;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg {
            color: #e74c3c;
            margin-top: 1rem;
            max-width: 400px;
            display: none;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 50;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            color: #555;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            transition: background 0.2s;
        }

        .zoom-btn:hover {
            background: #f0f0f0;
        }

        /* Mobile Responsiveness */
        .sidebar-toggle {
            display: none;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 900;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 85%;
                max-width: 320px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .sidebar-overlay.open {
                display: block;
            }

            .mobile-close-btn {
                display: block !important;
            }

            .zoom-controls {
                top: auto;
                bottom: 80px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading Plant Data...</p>
        <div id="errorMsg" class="error-msg">
            <i class="fas fa-exclamation-triangle"></i><br>
            <strong>Failed to load data.</strong><br>
            If you are opening this file locally, browsers block reading CSV files for security.<br>
            Please use a local server (e.g., VS Code Live Server) or upload to GitHub Pages.
        </div>
    </div>

    <header>
        <div class="header-title">
            <i class="fas fa-leaf"></i>
            PLANTalytics Visual Explorer
        </div>
        <a href="index.html" class="header-link">
            <i class="fas fa-home"></i> Back to Home
        </a>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <aside class="sidebar" id="sidebar">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <div class="header-title" style="font-size:1rem; color:var(--primary-color);">
                    <i class="fas fa-leaf"></i> Filters
                </div>
                <button onclick="toggleSidebar()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; display:none;" class="mobile-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-val" id="countVisible">0</div>
                    <div class="stat-lbl">Plants Shown</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="countImages">0</div>
                    <div class="stat-lbl">With Images</div>
                </div>
            </div>

            <div class="filter-card">
                <div class="sidebar-header">Search</div>
                <input type="text" id="searchFilter" placeholder="Common name, genus..." oninput="debounceFilter()">
            </div>

            <div class="filter-card">
                <div class="sidebar-header">Hardiness Zone</div>
                <div style="margin-bottom: 0.8rem;">
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="zipInput" placeholder="Zip Code" maxlength="5" style="width: 100px;">
                        <button onclick="lookupZip()" style="padding: 0 12px; background: var(--secondary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Go</button>
                        <div id="zipResult" style="display: flex; align-items: center; font-size: 0.85rem; font-weight: bold; color: var(--primary-color);"></div>
                    </div>
                </div>
                <div class="filter-label">
                    <span>Select your region</span>
                    <span id="zoneValue" style="color:var(--primary-color)">All</span>
                </div>
                <div class="zone-selector" id="zoneSelector">
                    <!-- Generated by JS -->
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888; margin-top:4px;">
                    <span>Cold (1)</span>
                    <span>Hot (13)</span>
                </div>
            </div>

            <div class="filter-card">
                <div class="sidebar-header">Plant Height (m)</div>
                <div class="range-container">
                    <div class="range-track"></div>
                    <div class="range-fill" id="heightFill"></div>
                    <input type="range" min="0" max="50" value="0" class="range-input" id="heightMin" oninput="updateHeightSlider()">
                    <input type="range" min="0" max="50" value="50" class="range-input" id="heightMax" oninput="updateHeightSlider()">
                </div>
                <div class="range-values">
                    <span id="heightMinVal">0m</span>
                    <span id="heightMaxVal">50m+</span>
                </div>
            </div>

            <div class="filter-card">
                <div class="sidebar-header">Filters</div>
                <div style="display:flex; flex-direction:column; gap:1rem;">
                    <div>
                        <label class="filter-label">Family</label>
                        <select id="familyFilter" onchange="applyFilters()">
                            <option value="">All Families</option>
                        </select>
                    </div>
                    <div>
                        <label class="filter-label">Growth Rate</label>
                        <select id="growthFilter" onchange="applyFilters()">
                            <option value="">All Rates</option>
                        </select>
                    </div>
                </div>
            </div>

            <button onclick="resetFilters()" style="padding:0.8rem; background:#eee; border:none; border-radius:6px; cursor:pointer; font-weight:600; color:#555; transition:background 0.2s;">
                <i class="fas fa-undo"></i> Reset All Filters
            </button>
        </aside>

        <!-- Visualization -->
        <main class="viz-area">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-filter"></i> Filters
            </button>
            <div id="spiralContainer"></div>
            
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()"><i class="fas fa-plus"></i></button>
                <button class="zoom-btn" onclick="zoomOut()"><i class="fas fa-minus"></i></button>
                <button class="zoom-btn" onclick="resetZoom()"><i class="fas fa-compress-arrows-alt"></i></button>
            </div>

            <div class="tooltip" id="tooltip"></div>

            <div class="list-toggle" onclick="toggleList()">
                <i class="fas fa-list"></i> Show List View
            </div>

            <div class="list-panel" id="listPanel">
                <div class="list-header">
                    <h3>Plant List</h3>
                    <button onclick="toggleList()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="list-content">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Common Name</th>
                                <th>Scientific Name</th>
                                <th>Family</th>
                                <th>Height (m)</th>
                                <th>Zone</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let zoomTransform = d3.zoomIdentity;
        let svg, g;
        let selectedZone = null;
        let zipData = {};
        
        // Configuration
        const CONFIG = {
            nodeSize: 40,
            padding: 5,
            maxNodes: 600
        };

        // Initialize
        function init() {
            setupZoneSelector();
            setupD3();
            loadData();
            loadZipData();
            
            // Hide header if in iframe
            if (window.self !== window.top) {
                const header = document.querySelector('header');
                if(header) header.style.display = 'none';
            }
        }

        function setupD3() {
            const container = document.getElementById('spiralContainer');
            svg = d3.select("#spiralContainer")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .call(d3.zoom().scaleExtent([0.1, 8]).on("zoom", zoomed))
                .on("dblclick.zoom", null);

            g = svg.append("g");
            
            // Initial center
            const t = d3.zoomIdentity.translate(container.clientWidth/2, container.clientHeight/2).scale(0.8);
            svg.call(d3.zoom().transform, t);
        }

        function setupZoneSelector() {
            const container = document.getElementById('zoneSelector');
            const colors = d3.scaleSequential(d3.interpolateTurbo).domain([13, 1]); // Cold to Hot
            
            for(let i=1; i<=13; i++) {
                const div = document.createElement('div');
                div.className = 'zone-segment';
                div.style.backgroundColor = colors(i);
                div.textContent = i;
                div.title = `Zone ${i}`;
                div.onclick = () => toggleZone(i);
                div.dataset.zone = i;
                container.appendChild(div);
            }
        }

        function toggleZone(zone) {
            const segments = document.querySelectorAll('.zone-segment');
            
            if (selectedZone === zone) {
                // Deselect
                selectedZone = null;
                document.getElementById('zoneValue').textContent = 'All';
                segments.forEach(s => {
                    s.classList.remove('active', 'dimmed');
                });
            } else {
                // Select
                selectedZone = zone;
                document.getElementById('zoneValue').textContent = `Zone ${zone}`;
                segments.forEach(s => {
                    if (parseInt(s.dataset.zone) === zone) {
                        s.classList.add('active');
                        s.classList.remove('dimmed');
                    } else {
                        s.classList.remove('active');
                        s.classList.add('dimmed');
                    }
                });
            }
            applyFilters();
        }

        function updateHeightSlider() {
            const minInput = document.getElementById('heightMin');
            const maxInput = document.getElementById('heightMax');
            const minVal = parseInt(minInput.value);
            const maxVal = parseInt(maxInput.value);

            // Prevent crossover
            if (minVal > maxVal - 1) {
                if (document.activeElement === minInput) minInput.value = maxVal - 1;
                else maxInput.value = minVal + 1;
            }

            const min = parseInt(minInput.value);
            const max = parseInt(maxInput.value);

            document.getElementById('heightMinVal').textContent = min + 'm';
            document.getElementById('heightMaxVal').textContent = max >= 50 ? '50m+' : max + 'm';

            // Update visual fill
            const percent1 = (min / minInput.max) * 100;
            const percent2 = (max / maxInput.max) * 100;
            const fill = document.getElementById('heightFill');
            fill.style.left = percent1 + "%";
            fill.style.width = (percent2 - percent1) + "%";

            debounceFilter();
        }

        function zoomed(event) {
            g.attr("transform", event.transform);
            zoomTransform = event.transform;
        }

        function zoomIn() { svg.transition().call(d3.zoom().scaleBy, 1.3); }
        function zoomOut() { svg.transition().call(d3.zoom().scaleBy, 1/1.3); }
        function resetZoom() {
            const container = document.getElementById('spiralContainer');
            const t = d3.zoomIdentity.translate(container.clientWidth/2, container.clientHeight/2).scale(0.8);
            svg.transition().duration(750).call(d3.zoom().transform, t);
        }

        function loadZipData() {
            Papa.parse('zip_zone.csv', {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    results.data.forEach(d => {
                        if (d.zipcode && d.zone) {
                            let z = String(d.zipcode).padStart(5, '0');
                            zipData[z] = d.zone;
                        }
                    });
                },
                error: function(err) {
                    console.warn('Zip Data Load Error:', err);
                }
            });
        }

        function lookupZip() {
            const input = document.getElementById('zipInput');
            const result = document.getElementById('zipResult');
            const zip = input.value.trim();
            
            if (zip.length !== 5) {
                result.textContent = 'Invalid Zip';
                result.style.color = 'red';
                return;
            }

            const zoneStr = zipData[zip];
            if (zoneStr) {
                const zoneNum = parseInt(zoneStr);
                result.textContent = `Zone ${zoneStr}`;
                result.style.color = 'var(--primary-color)';
                
                if (!isNaN(zoneNum)) {
                    if (selectedZone !== zoneNum) {
                        toggleZone(zoneNum);
                    }
                }
            } else {
                result.textContent = 'Not Found';
                result.style.color = 'red';
            }
        }

        // Load Data
        function loadData() {
            // Check for local file protocol
            if (window.location.protocol === 'file:') {
                console.warn('Running locally via file:// protocol. CSV loading might fail due to CORS.');
            }

            Papa.parse('plant_data.csv', {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    // Pre-process data
                    allData = results.data.filter(d => d.CommonName && d.Family);
                    
                    // Clean height data
                    allData.forEach(d => {
                        d.HeightVal = parseFloat(d.Height) || 999;
                        d.hasImage = d['Image URL'] && d['Image URL'].length > 5;
                    });

                    populateFilters();
                    applyFilters();
                    
                    document.getElementById('loading').style.display = 'none';
                },
                error: function(err) {
                    console.error('CSV Load Error:', err);
                    document.querySelector('.spinner').style.display = 'none';
                    document.getElementById('errorMsg').style.display = 'block';
                }
            });
        }

        function populateFilters() {
            const populate = (id, field) => {
                const unique = [...new Set(allData.map(d => d[field]))].filter(Boolean).sort();
                const select = document.getElementById(id);
                unique.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    select.appendChild(opt);
                });
            };

            populate('familyFilter', 'Family');
            populate('growthFilter', 'GrowthRate');
        }

        let debounceTimer;
        function debounceFilter() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(applyFilters, 300);
        }

        function applyFilters() {
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const family = document.getElementById('familyFilter').value;
            const growth = document.getElementById('growthFilter').value;
            
            const minHeight = parseInt(document.getElementById('heightMin').value);
            const maxHeight = parseInt(document.getElementById('heightMax').value);

            filteredData = allData.filter(d => {
                // Search
                const matchSearch = !search || 
                    (d.CommonName && d.CommonName.toLowerCase().includes(search)) || 
                    (d.Genus && d.Genus.toLowerCase().includes(search));
                
                // Dropdowns
                const matchFamily = !family || d.Family === family;
                const matchGrowth = !growth || d.GrowthRate === growth;
                
                // Height Slider
                const h = d.HeightVal;
                const matchHeight = (h >= minHeight) && (maxHeight >= 50 ? true : h <= maxHeight);

                // Zone Selector
                let matchZone = true;
                if (selectedZone) {
                    // Check if plant has zone info
                    if (!d.HardinessZones) {
                        matchZone = false;
                    } else {
                        const strZones = String(d.HardinessZones);
                        // Direct match
                        if (strZones.includes(String(selectedZone))) {
                            matchZone = true;
                        } 
                        // Range match "5 to 9"
                        else if (strZones.includes('to')) {
                            const parts = strZones.split('to').map(p => parseInt(p));
                            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                                matchZone = selectedZone >= parts[0] && selectedZone <= parts[1];
                            } else {
                                matchZone = false;
                            }
                        } else {
                            matchZone = false;
                        }
                    }
                }

                return matchSearch && matchFamily && matchGrowth && matchHeight && matchZone;
            });

            // Sort by Height (Smallest -> Largest) for the spiral
            filteredData.sort((a, b) => a.HeightVal - b.HeightVal);

            updateStats();
            renderSpiral();
            updateList();
        }

        function updateStats() {
            document.getElementById('countVisible').textContent = filteredData.length.toLocaleString();
            document.getElementById('countImages').textContent = filteredData.filter(d => d.hasImage).length.toLocaleString();
        }

        function renderSpiral() {
            const displayData = filteredData.slice(0, CONFIG.maxNodes);

            // Calculate positions (Phyllotaxis Spiral)
            const c = CONFIG.nodeSize + CONFIG.padding;
            
            displayData.forEach((d, i) => {
                const angle = i * 2.39996; // ~137.5 degrees
                const r = c * Math.sqrt(i);
                d.x = r * Math.cos(angle);
                d.y = r * Math.sin(angle);
            });

            // D3 Update
            const nodes = g.selectAll(".node-group")
                .data(displayData, d => d.CommonName + d.Genus);

            nodes.exit()
                .transition().duration(500)
                .attr("opacity", 0)
                .remove();

            const enter = nodes.enter()
                .append("g")
                .attr("class", "node-group")
                .attr("transform", d => `translate(${d.x}, ${d.y})`)
                .attr("opacity", 0);

            enter.append("circle")
                .attr("r", CONFIG.nodeSize / 2)
                .attr("fill", "#ddd")
                .attr("stroke", "white")
                .attr("stroke-width", 2);

            enter.filter(d => d.hasImage)
                .append("image")
                .attr("xlink:href", d => d['Image URL'])
                .attr("x", -CONFIG.nodeSize/2)
                .attr("y", -CONFIG.nodeSize/2)
                .attr("width", CONFIG.nodeSize)
                .attr("height", CONFIG.nodeSize)
                .style("clip-path", "circle(50%)");

            const update = enter.merge(nodes);
            
            update.transition().duration(750)
                .attr("transform", d => `translate(${d.x}, ${d.y})`)
                .attr("opacity", 1);

            update.on("mouseenter", function(event, d) {
                d3.select(this).raise().select("circle, image")
                    .transition().duration(200)
                    .attr("transform", "scale(1.5)");
                showTooltip(event, d);
            })
            .on("mouseleave", function() {
                d3.select(this).select("circle, image")
                    .transition().duration(200)
                    .attr("transform", "scale(1)");
                hideTooltip();
            })
            .on("click", (e, d) => {
                if(d.PFAF) window.open(d.PFAF, '_blank');
            });
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <h4>${d.CommonName}</h4>
                <p><i>${d.Genus} ${d.Species}</i></p>
                <p>Height: ${d.Height || '?'} m</p>
                <p>Zone: ${d.HardinessZones || '?'}</p>
                <p style="font-size:0.8rem; margin-top:5px; color:#888;">Click to view details</p>
            `;
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }

        function resetFilters() {
            document.getElementById('searchFilter').value = '';
            document.getElementById('familyFilter').value = '';
            document.getElementById('growthFilter').value = '';
            
            // Reset Slider
            document.getElementById('heightMin').value = 0;
            document.getElementById('heightMax').value = 50;
            updateHeightSlider();

            // Reset Zone
            selectedZone = null;
            toggleZone(null); // This will clear it
            
            applyFilters();
        }

        function toggleList() {
            const panel = document.getElementById('listPanel');
            panel.classList.toggle('open');
            const btn = document.querySelector('.list-toggle');
            btn.innerHTML = panel.classList.contains('open') ? 
                '<i class="fas fa-chevron-down"></i> Hide List' : 
                '<i class="fas fa-list"></i> Show List View';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('open');
        }

        function updateList() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            
            filteredData.slice(0, 50).forEach(d => {
                const tr = document.createElement('tr');
                const imgHtml = d.hasImage ? 
                    `<img src="${d['Image URL']}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">` : 
                    `<div style="width:30px; height:30px; border-radius:50%; background:#eee; display:flex; align-items:center; justify-content:center; font-size:0.7rem;">?</div>`;
                
                tr.innerHTML = `
                    <td>${imgHtml}</td>
                    <td>${d.CommonName}</td>
                    <td><i>${d.Genus} ${d.Species}</i></td>
                    <td>${d.Family}</td>
                    <td>${d.Height || '-'}</td>
                    <td>${d.HardinessZones}</td>
                `;
                tr.onclick = () => {
                    if(d.PFAF) window.open(d.PFAF, '_blank');
                };
                tbody.appendChild(tr);
            });
        }

        // Start
        init();

    </script>
</body>
</html>
