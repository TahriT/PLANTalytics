<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLANTalytics - Visual Explorer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2d5016;
            --secondary-color: #6b9e3e;
            --accent-color: #9ec472;
            --dark-bg: #1a1a1a;
            --light-bg: #f5f5f5;
            --text-dark: #333;
            --text-light: #fff;
            --zone-cold: #3498db;
            --zone-hot: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-light);
            padding: 0.75rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 10;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .header-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: background 0.3s;
            font-size: 0.9rem;
        }

        .header-link:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 340px;
            background: white;
            padding: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 5;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, margin-left 0.3s ease;
        }

        .sidebar.collapsed {
            width: 60px;
            margin-left: 0;
            overflow: hidden;
        }

        .sidebar.collapsed .sidebar-content,
        .sidebar.collapsed .sidebar-hero,
        .sidebar.collapsed .sidebar-header h2,
        .sidebar.collapsed .mobile-close-btn,
        .sidebar.collapsed .desktop-close-btn {
            display: none !important;
        }

        /* Mini Sidebar Icons */
        .sidebar-mini {
            display: none;
            flex-direction: column;
            align-items: center;
            padding-top: 1rem;
            gap: 1.5rem;
        }

        .sidebar.collapsed .sidebar-mini {
            display: flex;
        }

        .mini-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f2f5;
            color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .mini-icon:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .sidebar-hero {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .sidebar-hero h2 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-hero p {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .sidebar-section {
            padding: 0 1.5rem 1.5rem 1.5rem;
            border-bottom: 1px solid #eee;
            margin-bottom: 1.5rem;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .section-step {
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #888;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            display: block;
        }

        .sidebar-header {
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Visual Filters */
        .filter-card {
            background: #fff;
            border-radius: 8px;
        }

        .filter-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #555;
            display: flex;
            justify-content: space-between;
        }

        /* Zone Selector */
        .zone-selector {
            display: flex;
            height: 40px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .zone-segment {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            font-weight: bold;
            transition: all 0.2s;
            position: relative;
        }

        .zone-segment:hover {
            transform: scaleY(1.1);
            z-index: 2;
        }

        .zone-segment.active {
            box-shadow: inset 0 0 0 2px white;
            transform: scaleY(1.15);
            z-index: 3;
            font-size: 0.9rem;
        }

        .zone-segment.dimmed {
            opacity: 0.3;
        }

        /* Range Slider */
        .range-container {
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .range-track {
            position: absolute;
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
        }

        .range-fill {
            position: absolute;
            height: 6px;
            background: var(--secondary-color);
            border-radius: 3px;
        }

        .range-input {
            position: absolute;
            width: 100%;
            height: 6px;
            background: none;
            pointer-events: none;
            -webkit-appearance: none;
            z-index: 2;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-top: -6px; /* Adjust for track height */
        }
        
        /* Firefox support */
        .range-input::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        /* Standard Inputs */
        select, input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        select:focus, input[type="text"]:focus {
            border-color: var(--secondary-color);
            outline: none;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-val {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-lbl {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }

        /* Main Layout */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Visualization Area */
        .viz-area {
            flex: 8; /* 80% height */
            display: flex;
            flex-direction: column;
            position: relative;
            background: radial-gradient(circle at center, #f7f9f4 0%, #eef1e8 100%);
            overflow: hidden;
            border-bottom: 1px solid #ddd;
        }

        #spiralContainer {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            cursor: grab;
            border: 1px solid rgba(0,0,0,0.1); /* Debug border */
        }

        #spiralContainer:active {
            cursor: grabbing;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            pointer-events: none;
            font-size: 0.9rem;
            z-index: 1000;
            max-width: 280px;
            opacity: 0;
            transition: opacity 0.2s;
            border-left: 4px solid var(--primary-color);
        }

        .tooltip h4 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        /* List View */
        .list-panel {
            flex: 2; /* 20% height */
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 10;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .list-header {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9f9f9;
            flex-shrink: 0;
        }

        .list-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            position: sticky;
            top: 0;
            background: #f9f9f9;
            padding: 0.5rem 1rem;
            text-align: left;
            font-size: 0.8rem;
            color: #666;
            border-bottom: 2px solid #eee;
            z-index: 2;
        }

        td {
            padding: 0.4rem 1rem;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }

        tr:hover {
            background: #f5f9f0;
            cursor: pointer;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #sidebar {
                position: fixed;
                left: -320px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s ease;
            }

            #sidebar.open {
                left: 0;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 90;
                display: none;
            }

            .sidebar-overlay.open {
                display: block;
            }

            main {
                width: 100%;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            
            .viz-area {
                flex: 1; /* Split evenly on mobile or adjust */
                min-height: 40vh;
            }
            
            .list-panel {
                flex: 1;
                min-height: 40vh;
            }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg {
            color: #e74c3c;
            margin-top: 1rem;
            max-width: 400px;
            display: none;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 50;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            color: #555;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            transition: background 0.2s;
        }

        .zoom-btn:hover {
            background: #f0f0f0;
        }

        /* Mobile Responsiveness */
        .sidebar-toggle {
            display: none;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
        }

        /* Show toggle when sidebar is collapsed on desktop */
        .sidebar.collapsed + main .sidebar-toggle {
            display: none; /* Handled by mini sidebar now */
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 900;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 85%;
                max-width: 320px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .sidebar-overlay.open {
                display: block;
            }

            .mobile-close-btn {
                display: block !important;
            }

            .desktop-close-btn {
                display: none !important;
            }

            .zoom-controls {
                top: auto;
                bottom: 80px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Tooltip Container -->
    <div id="tooltip" class="tooltip"></div>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading Plant Data...</p>
        <div id="errorMsg" class="error-msg">
            <i class="fas fa-exclamation-triangle"></i><br>
            <strong>Failed to load data.</strong><br>
            If you are opening this file locally, browsers block reading CSV files for security.<br>
            Please use a local server (e.g., VS Code Live Server) or upload to GitHub Pages.
        </div>
    </div>

    <div class="app-container" style="display:flex; height:100vh; width:100%;">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <!-- Mini Sidebar (Visible when collapsed) -->
            <div class="sidebar-mini">
                <div class="mini-icon" onclick="toggleSidebar()" title="Expand Filters">
                    <i class="fas fa-filter"></i>
                </div>
                <div class="mini-icon" onclick="toggleSidebar()" title="Search">
                    <i class="fas fa-search"></i>
                </div>
                <div class="mini-icon" onclick="toggleSidebar()" title="Zones">
                    <i class="fas fa-temperature-low"></i>
                </div>
                <div class="mini-icon" onclick="toggleSidebar()" title="Settings">
                    <i class="fas fa-cog"></i>
                </div>
            </div>

            <div class="sidebar-header" style="padding: 1.5rem; background: var(--primary-color); color: white;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0; font-size:1.2rem;"><i class="fas fa-leaf"></i> PLANTalytics</h2>
                    <button class="mobile-close-btn" onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer; display:none;">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="desktop-close-btn" onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:1rem; cursor:pointer; opacity:0.8;" title="Collapse Sidebar">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
            </div>
            
            <div class="sidebar-content" style="padding: 1.5rem; overflow-y: auto; height: calc(100% - 70px);">
                <!-- Search -->
                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:600;">Search Plants</label>
                    <input type="text" id="searchFilter" placeholder="e.g. Oak, Acer..." oninput="debounceFilter()">
                </div>

                <!-- Zip Code -->
                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:600;">Your Zip Code (US)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="zipInput" placeholder="Zip Code" maxlength="5">
                        <button onclick="lookupZip()" style="padding:0 10px; background:var(--primary-color); color:white; border:none; border-radius:4px; cursor:pointer;">Go</button>
                    </div>
                    <div id="zipResult" style="font-size:0.8rem; margin-top:5px; font-weight:bold;"></div>
                </div>

                <!-- Zone Selector -->
                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:600;">Hardiness Zone: <span id="zoneValue" style="color:var(--primary-color)">All</span></label>
                    <div class="zone-selector" id="zoneSelector"></div>
                    <div class="range-values">
                        <span>Cold (1)</span>
                        <span>Hot (13)</span>
                    </div>
                </div>

                <!-- Color By -->
                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:600;">Color Nodes By</label>
                    <select id="colorByFilter" onchange="applyFilters()">
                        <option value="none">None (Spiral Layout)</option>
                        <option value="family">Family (Grouped)</option>
                        <option value="edibility">Edibility (Grouped)</option>
                        <option value="ph">pH Preference (Grouped)</option>
                        <option value="growth">Growth Rate (Grouped)</option>
                    </select>
                </div>

                <!-- Height Slider -->
                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:600;">Height Range</label>
                    <div class="range-container">
                        <div class="range-track"></div>
                        <div class="range-fill" id="heightFill"></div>
                        <input type="range" id="heightMin" min="0" max="50" value="0" class="range-input" oninput="updateHeightSlider()">
                        <input type="range" id="heightMax" min="0" max="50" value="50" class="range-input" oninput="updateHeightSlider()">
                    </div>
                    <div class="range-values">
                        <span id="heightMinVal">0m</span>
                        <span id="heightMaxVal">50m+</span>
                    </div>
                </div>

                <!-- Dropdowns -->
                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:600;">Family</label>
                    <select id="familyFilter" onchange="applyFilters()">
                        <option value="">All Families</option>
                    </select>
                </div>

                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:600;">Growth Rate</label>
                    <select id="growthFilter" onchange="applyFilters()">
                        <option value="">Any</option>
                    </select>
                </div>

                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:600;">Min Edibility Rating</label>
                    <select id="edibilityFilter" onchange="applyFilters()">
                        <option value="0">Any</option>
                        <option value="1">1+ (Minor)</option>
                        <option value="2">2+ (Fair)</option>
                        <option value="3">3+ (Good)</option>
                        <option value="4">4+ (Very Good)</option>
                        <option value="5">5 (Excellent)</option>
                    </select>
                </div>

                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-val" id="countVisible">-</div>
                        <div class="stat-lbl">Plants</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-val" id="countImages">-</div>
                        <div class="stat-lbl">Images</div>
                    </div>
                </div>

                <button onclick="resetFilters()" style="width:100%; margin-top:1rem; padding:0.8rem; background:#eee; border:none; border-radius:6px; cursor:pointer; font-weight:bold; color:#666;">
                    Reset All Filters
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main>
            <!-- Mobile Header -->
            <header class="mobile-header" style="display:none; padding:10px; background:white; border-bottom:1px solid #eee; align-items:center; justify-content:space-between;">
                <button onclick="toggleSidebar()" style="background:none; border:none; font-size:1.2rem; color:var(--primary-color); cursor:pointer;">
                    <i class="fas fa-bars"></i> Filters
                </button>
                <h3 style="margin:0; color:var(--primary-color);">PLANTalytics</h3>
                <div style="width:24px;"></div> <!-- Spacer -->
            </header>

            <div class="viz-area">
                <div class="viz-controls" style="position:absolute; top:15px; right:15px; z-index:10; display:flex; gap:10px;">
                    <button onclick="zoomIn()" class="btn-icon" style="width:36px; height:36px; background:white; border:none; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer;"><i class="fas fa-plus"></i></button>
                    <button onclick="zoomOut()" class="btn-icon" style="width:36px; height:36px; background:white; border:none; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer;"><i class="fas fa-minus"></i></button>
                    <button onclick="resetZoom()" class="btn-icon" style="width:36px; height:36px; background:white; border:none; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer;"><i class="fas fa-compress-arrows-alt"></i></button>
                </div>
                <div id="spiralContainer"></div>
            </div>

            <div class="list-panel" id="listPanel">
                <div class="list-header">
                    <h3>Plant List</h3>
                    <span style="font-size:0.8rem; color:#666;">Scroll to see more</span>
                </div>
                <div class="list-content">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th style="width:50px">Img</th>
                                <th>Name</th>
                                <th>Scientific</th>
                                <th>Family</th>
                                <th>Height (m)</th>
                                <th>Zone</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>


    <script>
        let allData = [];
        let filteredData = [];
        let selectedZone = null;
        let zipData = {};
        
        // D3 Globals
        let svg, g, zoom;
        let simulation;
        let width, height;

        // Configuration
        const CONFIG = {
            nodeSize: 25,
            padding: 5,
            maxNodes: 600
        };

        // Initialize
        function init() {
            console.log('Initializing Dashboard...');
            try {
                setupZoneSelector();
                setupD3();
                loadData();
                loadZipData();
                
                // Hide header if in iframe
                if (window.self !== window.top) {
                    const header = document.querySelector('header');
                    if(header) header.style.display = 'none';
                }

                window.addEventListener('resize', onWindowResize);
            } catch (e) {
                console.error('Initialization Error:', e);
                alert('An error occurred during initialization: ' + e.message);
            }
        }

        function setupD3() {
            const container = document.getElementById('spiralContainer');
            width = container.clientWidth || window.innerWidth;
            height = container.clientHeight || window.innerHeight;
            
            console.log(`Setup D3: ${width}x${height}`);

            // Clear any existing
            container.innerHTML = '';

            svg = d3.select('#spiralContainer').append('svg')
                .attr('width', width)
                .attr('height', height)
                .style('background', 'transparent');
            
            // Add Gloss Gradient
            const defs = svg.append('defs');
            const gradient = defs.append('radialGradient')
                .attr('id', 'glossGradient')
                .attr('cx', '30%')
                .attr('cy', '30%')
                .attr('r', '70%');
            
            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', 'rgba(255,255,255,0.8)');
                
            gradient.append('stop')
                .attr('offset', '20%')
                .attr('stop-color', 'rgba(255,255,255,0.4)');
                
            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', 'rgba(255,255,255,0)');
            
            g = svg.append('g');

            zoom = d3.zoom()
                .scaleExtent([0.1, 8])
                .on('zoom', (e) => g.attr('transform', e.transform));

            svg.call(zoom);
            
            // Don't set initial transform here - let renderViz handle it
            console.log('D3 setup complete');
        }

        function onWindowResize() {
            const container = document.getElementById('spiralContainer');
            width = container.clientWidth;
            height = container.clientHeight;
            svg.attr('width', width).attr('height', height);
            renderViz();
        }

        function setupZoneSelector() {
            const container = document.getElementById('zoneSelector');
            const colors = d3.scaleSequential(d3.interpolateTurbo).domain([13, 1]); // Cold to Hot
            
            for(let i=1; i<=13; i++) {
                const div = document.createElement('div');
                div.className = 'zone-segment';
                div.style.backgroundColor = colors(i);
                div.textContent = i;
                div.title = `Zone ${i}`;
                div.onclick = () => toggleZone(i);
                div.dataset.zone = i;
                container.appendChild(div);
            }
        }

        function toggleZone(zone) {
            const segments = document.querySelectorAll('.zone-segment');
            
            if (selectedZone === zone) {
                // Deselect
                selectedZone = null;
                document.getElementById('zoneValue').textContent = 'All';
                segments.forEach(s => {
                    s.classList.remove('active', 'dimmed');
                });
            } else {
                // Select
                selectedZone = zone;
                document.getElementById('zoneValue').textContent = `Zone ${zone}`;
                segments.forEach(s => {
                    if (parseInt(s.dataset.zone) === zone) {
                        s.classList.add('active');
                        s.classList.remove('dimmed');
                    } else {
                        s.classList.remove('active');
                        s.classList.add('dimmed');
                    }
                });
            }
            applyFilters();
        }

        function updateHeightSlider() {
            const minInput = document.getElementById('heightMin');
            const maxInput = document.getElementById('heightMax');
            const minVal = parseInt(minInput.value);
            const maxVal = parseInt(maxInput.value);

            // Prevent crossover
            if (minVal > maxVal - 1) {
                if (document.activeElement === minInput) minInput.value = maxVal - 1;
                else maxInput.value = minVal + 1;
            }

            const min = parseInt(minInput.value);
            const max = parseInt(maxInput.value);

            document.getElementById('heightMinVal').textContent = min + 'm';
            document.getElementById('heightMaxVal').textContent = max >= 50 ? '50m+' : max + 'm';

            // Update visual fill
            const percent1 = (min / minInput.max) * 100;
            const percent2 = (max / maxInput.max) * 100;
            const fill = document.getElementById('heightFill');
            fill.style.left = percent1 + "%";
            fill.style.width = (percent2 - percent1) + "%";

            debounceFilter();
        }

        function zoomed(event) {
            // No-op
        }

        function zoomIn() { 
            zoom.scaleBy(svg.transition().duration(750), 1.2);
        }
        function zoomOut() { 
            zoom.scaleBy(svg.transition().duration(750), 0.8);
        }
        function resetZoom() {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(width/2, height/2).scale(0.8));
        }

        function loadZipData() {
            Papa.parse('zip_zone.csv', {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    results.data.forEach(d => {
                        if (d.zipcode && d.zone) {
                            let z = String(d.zipcode).padStart(5, '0');
                            zipData[z] = d.zone;
                        }
                    });
                },
                error: function(err) {
                    console.warn('Zip Data Load Error:', err);
                }
            });
        }

        function lookupZip() {
            const input = document.getElementById('zipInput');
            const result = document.getElementById('zipResult');
            const zip = input.value.trim();
            
            if (zip.length !== 5) {
                result.textContent = 'Invalid Zip';
                result.style.color = 'red';
                return;
            }

            const zoneStr = zipData[zip];
            if (zoneStr) {
                const zoneNum = parseInt(zoneStr);
                result.textContent = `Zone ${zoneStr}`;
                result.style.color = 'var(--primary-color)';
                
                if (!isNaN(zoneNum)) {
                    if (selectedZone !== zoneNum) {
                        toggleZone(zoneNum);
                    }
                }
            } else {
                result.textContent = 'Not Found';
                result.style.color = 'red';
            }
        }

        // Load Data
        function loadData() {
            // Check for local file protocol
            if (window.location.protocol === 'file:') {
                console.warn('Running locally via file:// protocol. CSV loading might fail due to CORS.');
            }

            Papa.parse('plant_data.csv', {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    // Pre-process data
                    allData = results.data.filter(d => d.CommonName && d.Family);
                    
                    // Clean height data & Assign IDs
                    let idCounter = 0;
                    allData.forEach(d => {
                        d._id = 'p' + (idCounter++);
                        d.HeightVal = parseFloat(d.Height) || 999;
                        d.hasImage = d['Image URL'] && d['Image URL'].length > 5;
                    });

                    populateFilters();
                    applyFilters();
                    
                    console.log(`Loaded ${allData.length} plants.`);
                    document.getElementById('loading').style.display = 'none';
                },
                error: function(err) {
                    console.error('CSV Load Error:', err);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('errorMsg').style.display = 'block';
                    document.getElementById('errorMsg').innerHTML += '<br><small>' + (err.message || err) + '</small>';
                }
            });
        }

        function populateFilters() {
            const populate = (id, field) => {
                const unique = [...new Set(allData.map(d => d[field]))].filter(Boolean).sort();
                const select = document.getElementById(id);
                unique.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    select.appendChild(opt);
                });
            };

            populate('familyFilter', 'Family');
            populate('growthFilter', 'GrowthRate');
        }

        let debounceTimer;
        function debounceFilter() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(applyFilters, 300);
        }

        function applyFilters() {
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const family = document.getElementById('familyFilter').value;
            const growth = document.getElementById('growthFilter').value;
            const minEdibility = parseInt(document.getElementById('edibilityFilter').value);
            
            const minHeight = parseInt(document.getElementById('heightMin').value);
            const maxHeight = parseInt(document.getElementById('heightMax').value);

            filteredData = allData.filter(d => {
                // Search
                const matchSearch = !search || 
                    (d.CommonName && d.CommonName.toLowerCase().includes(search)) || 
                    (d.Genus && d.Genus.toLowerCase().includes(search));
                
                // Dropdowns
                const matchFamily = !family || d.Family === family;
                const matchGrowth = !growth || d.GrowthRate === growth;
                
                // Edibility
                const matchEdibility = (d.Edibility || 0) >= minEdibility;
                
                // Height Slider
                const h = d.HeightVal;
                const matchHeight = (h >= minHeight) && (maxHeight >= 50 ? true : h <= maxHeight);

                // Zone Selector
                let matchZone = true;
                if (selectedZone) {
                    // Check if plant has zone info
                    if (!d.HardinessZones) {
                        matchZone = false;
                    } else {
                        const strZones = String(d.HardinessZones);
                        // Direct match
                        if (strZones.includes(String(selectedZone))) {
                            matchZone = true;
                        } 
                        // Range match "5 to 9"
                        else if (strZones.includes('to')) {
                            const parts = strZones.split('to').map(p => parseInt(p));
                            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                                matchZone = selectedZone >= parts[0] && selectedZone <= parts[1];
                            } else {
                                matchZone = false;
                            }
                        } else {
                            matchZone = false;
                        }
                    }
                }

                return matchSearch && matchFamily && matchGrowth && matchHeight && matchZone && matchEdibility;
            });

            // Sort by Height (Smallest -> Largest)
            filteredData.sort((a, b) => a.HeightVal - b.HeightVal);

            console.log(`Rendering ${filteredData.length} nodes.`);
            updateStats();
            renderViz();
            updateList();
        }

        function updateStats() {
            document.getElementById('countVisible').textContent = filteredData.length.toLocaleString();
            document.getElementById('countImages').textContent = filteredData.filter(d => d.hasImage).length.toLocaleString();
        }

        function renderViz() {
            try {
                const data = filteredData.slice(0, CONFIG.maxNodes);
                const colorMode = document.getElementById('colorByFilter').value;
                
                console.log(`RenderViz called with ${data.length} items, colorMode: ${colorMode}`);
                
                // Guard: make sure we have valid dimensions
                if (!width || !height || width < 100 || height < 100) {
                    const container = document.getElementById('spiralContainer');
                    width = container.clientWidth || 800;
                    height = container.clientHeight || 600;
                    console.log(`Fixed dimensions: ${width}x${height}`);
                }
                
                // Stop any previous simulation
                if (simulation) simulation.stop();

                // Bind Data
                const nodes = g.selectAll('.node')
                    .data(data, d => d._id);

                nodes.exit()
                    .transition().duration(500)
                    .attr('opacity', 0)
                    .remove();

                const enter = nodes.enter().append('g')
                    .attr('class', 'node')
                    .attr('opacity', 0)
                    .call(d3.drag()
                        .on('start', dragstarted)
                        .on('drag', dragged)
                        .on('end', dragended));

                // Circle Background
                enter.append('circle')
                    .attr('r', CONFIG.nodeSize)
                    .attr('fill', '#fff')
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 2);

                // Image (ClipPath)
                enter.append('clipPath')
                    .attr('id', d => `clip-${d._id}`)
                    .append('circle')
                    .attr('r', CONFIG.nodeSize);

                enter.append('image')
                    .attr('xlink:href', d => d.hasImage ? d['Image URL'] : '')
                    .attr('x', -CONFIG.nodeSize)
                    .attr('y', -CONFIG.nodeSize)
                    .attr('width', CONFIG.nodeSize * 2)
                    .attr('height', CONFIG.nodeSize * 2)
                    .attr('clip-path', d => `url(#clip-${d._id})`)
                    .style('display', d => d.hasImage ? 'block' : 'none')
                    .on('error', function(e, d) { 
                        d3.select(this).style('display', 'none'); 
                        d3.select(this.parentNode).select('.fallback').style('display', 'block');
                    }); 
                
                // Fallback Circle (if no image)
                enter.append('circle')
                    .attr('class', 'fallback')
                    .attr('r', CONFIG.nodeSize)
                    .attr('fill', d => getPlantColor(d, colorMode))
                    .style('display', d => d.hasImage ? 'none' : 'block');

                // Gloss Overlay for 3D Effect
                enter.append('circle')
                    .attr('r', CONFIG.nodeSize)
                    .attr('fill', 'url(#glossGradient)')
                    .style('pointer-events', 'none');

                // Merge
                const allNodes = enter.merge(nodes);

                // Animate Entry
                enter.attr('opacity', 1);

                // Update Colors
                allNodes.select('.fallback')
                    .transition().duration(500)
                    .attr('fill', d => getPlantColor(d, colorMode))
                    .style('display', d => d.hasImage ? 'none' : 'block');
                    
                allNodes.select('circle')
                    .transition().duration(500)
                    .attr('stroke', d => getPlantColor(d, colorMode));

                // Tooltip Events
                allNodes
                    .on('mouseenter', (e, d) => {
                        d3.select(e.currentTarget).transition().duration(200).attr('transform', `translate(${d.x},${d.y}) scale(1.5)`);
                        // Bring to front
                        e.currentTarget.parentNode.appendChild(e.currentTarget);
                        showTooltip(e, d);
                    })
                    .on('mouseleave', (e, d) => {
                        d3.select(e.currentTarget).transition().duration(200).attr('transform', `translate(${d.x},${d.y}) scale(1)`);
                        hideTooltip();
                    });

                // Layout Logic
                if (colorMode && colorMode !== 'none') {
                    // Force Layout for Grouping
                    const groups = Array.from(new Set(data.map(d => getGroupValue(d, colorMode))));
                    const centers = {};
                    
                    // Calculate grid
                    const cols = Math.ceil(Math.sqrt(groups.length));
                    const rows = Math.ceil(groups.length / cols);
                    const cellW = width / cols;
                    const cellH = height / rows;
                    
                    groups.forEach((grp, i) => {
                        centers[grp] = { 
                            x: (i % cols) * cellW + cellW/2 - width/2, 
                            y: Math.floor(i / cols) * cellH + cellH/2 - height/2,
                            label: String(grp)
                        };
                    });

                    // Create/Update group bubbles and labels
                    const groupData = groups.map(grp => ({
                        key: grp,
                        label: getGroupLabel(grp, colorMode),
                        color: getGroupColor(grp, colorMode),
                        cx: centers[grp].x,
                        cy: centers[grp].y,
                        r: Math.min(cellW, cellH) / 2.5
                    }));

                    // Remove old group elements
                    g.selectAll('.group-bubble').remove();
                    g.selectAll('.group-label').remove();

                    // Add group bubbles (behind nodes)
                    const bubbles = g.selectAll('.group-bubble')
                        .data(groupData, d => d.key)
                        .enter()
                        .insert('ellipse', '.node')
                        .attr('class', 'group-bubble')
                        .attr('cx', d => d.cx)
                        .attr('cy', d => d.cy)
                        .attr('rx', d => d.r)
                        .attr('ry', d => d.r * 0.8)
                        .attr('fill', d => d.color)
                        .attr('fill-opacity', 0.15)
                        .attr('stroke', d => d.color)
                        .attr('stroke-width', 2)
                        .attr('stroke-opacity', 0.4)
                        .style('pointer-events', 'none');

                    // Add group labels
                    const labels = g.selectAll('.group-label')
                        .data(groupData, d => d.key)
                        .enter()
                        .insert('text', '.node')
                        .attr('class', 'group-label')
                        .attr('x', d => d.cx)
                        .attr('y', d => d.cy - d.r + 20)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '14px')
                        .attr('font-weight', 'bold')
                        .attr('fill', d => d.color)
                        .attr('opacity', 0.9)
                        .style('pointer-events', 'none')
                        .text(d => d.label);

                    // Store group bounds for dynamic updates
                    const groupBounds = {};
                    groups.forEach(grp => {
                        groupBounds[grp] = { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity, count: 0 };
                    });

                    simulation = d3.forceSimulation(data)
                        .force('x', d3.forceX(d => centers[getGroupValue(d, colorMode)].x).strength(0.08))
                        .force('y', d3.forceY(d => centers[getGroupValue(d, colorMode)].y).strength(0.08))
                        .force('collide', d3.forceCollide(CONFIG.nodeSize + 5).strength(0.9))
                        .force('charge', d3.forceManyBody().strength(-20))
                        .alphaDecay(0.03)
                        .on('tick', () => {
                            allNodes.attr('transform', d => `translate(${d.x},${d.y})`);
                            
                            // Recalculate group bounds based on actual node positions
                            groups.forEach(grp => {
                                groupBounds[grp] = { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity, count: 0 };
                            });
                            
                            data.forEach(d => {
                                const grp = getGroupValue(d, colorMode);
                                const bounds = groupBounds[grp];
                                bounds.minX = Math.min(bounds.minX, d.x);
                                bounds.maxX = Math.max(bounds.maxX, d.x);
                                bounds.minY = Math.min(bounds.minY, d.y);
                                bounds.maxY = Math.max(bounds.maxY, d.y);
                                bounds.count++;
                            });
                            
                            // Update bubble positions and sizes dynamically
                            g.selectAll('.group-bubble')
                                .attr('cx', d => {
                                    const bounds = groupBounds[d.key];
                                    return bounds.count > 0 ? (bounds.minX + bounds.maxX) / 2 : d.cx;
                                })
                                .attr('cy', d => {
                                    const bounds = groupBounds[d.key];
                                    return bounds.count > 0 ? (bounds.minY + bounds.maxY) / 2 : d.cy;
                                })
                                .attr('rx', d => {
                                    const bounds = groupBounds[d.key];
                                    const padding = CONFIG.nodeSize * 2;
                                    return bounds.count > 0 ? Math.max((bounds.maxX - bounds.minX) / 2 + padding, CONFIG.nodeSize * 3) : d.r;
                                })
                                .attr('ry', d => {
                                    const bounds = groupBounds[d.key];
                                    const padding = CONFIG.nodeSize * 2;
                                    return bounds.count > 0 ? Math.max((bounds.maxY - bounds.minY) / 2 + padding, CONFIG.nodeSize * 3) : d.r * 0.8;
                                });
                            
                            // Update label positions
                            g.selectAll('.group-label')
                                .attr('x', d => {
                                    const bounds = groupBounds[d.key];
                                    return bounds.count > 0 ? (bounds.minX + bounds.maxX) / 2 : d.cx;
                                })
                                .attr('y', d => {
                                    const bounds = groupBounds[d.key];
                                    const padding = CONFIG.nodeSize * 2;
                                    const ry = bounds.count > 0 ? Math.max((bounds.maxY - bounds.minY) / 2 + padding, CONFIG.nodeSize * 3) : d.r * 0.8;
                                    const cy = bounds.count > 0 ? (bounds.minY + bounds.maxY) / 2 : d.cy;
                                    return cy - ry + 18;
                                });
                        });
                    
                    simulation.restart();
                    
                    // Auto Zoom to fit all groups - center on origin
                    console.log(`Force layout: centering at ${width/2},${height/2}`);
                    svg.call(
                        zoom.transform, 
                        d3.zoomIdentity.translate(width/2, height/2).scale(0.8)
                    );

                } else {
                    // Remove group elements when not grouping
                    g.selectAll('.group-bubble').remove();
                    g.selectAll('.group-label').remove();
                    
                    // Spiral Layout (Static)
                    const spacing = CONFIG.nodeSize * 2.2;
                    
                    data.forEach((d, i) => {
                        const angle = i * 0.5;
                        const r = spacing * Math.sqrt(i);
                        d.x = r * Math.cos(angle);
                        d.y = r * Math.sin(angle);
                    });

                    // Immediately set positions (no animation for initial render)
                    allNodes.attr('transform', d => `translate(${d.x},${d.y})`);
                        
                    // Auto Zoom to fit spiral - center on origin where spiral is
                    if (data.length > 0) {
                        const maxR = spacing * Math.sqrt(data.length);
                        const scale = Math.min(width, height) / (maxR * 2.5);
                        const finalScale = Math.max(0.3, Math.min(scale, 1.5));
                        
                        console.log(`Zoom: centering at ${width/2},${height/2} scale ${finalScale}`);
                        
                        svg.call(
                            zoom.transform, 
                            d3.zoomIdentity.translate(width/2, height/2).scale(finalScale)
                        );
                    }
                }
            } catch (err) {
                console.error("Render Error:", err);
            }
        }

        function dragstarted(event, d) {
            if (!event.active && simulation) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active && simulation) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function getGroupValue(d, mode) {
            if (mode === 'edibility') return d.Edibility || 0;
            if (mode === 'ph') {
                const ph = (d.pH || '').toLowerCase();
                if (ph.includes('acid') && ph.includes('basic')) return 'Wide';
                if (ph.includes('acid')) return 'Acid';
                if (ph.includes('basic') || ph.includes('alkaline')) return 'Base';
                return 'Neutral';
            }
            if (mode === 'growth') return d.GrowthRate || 'Unknown';
            if (mode === 'family') return d.Family || 'Unknown';
            return 'All';
        }

        function getGroupLabel(grp, mode) {
            if (mode === 'edibility') {
                const labels = {0: 'Not Edible', 1: 'Minor Use', 2: 'Fair', 3: 'Good', 4: 'Very Good', 5: 'Excellent'};
                return labels[grp] || `Edibility: ${grp}`;
            }
            if (mode === 'ph') {
                const labels = {'Acid': ' Acidic Soil', 'Base': ' Alkaline Soil', 'Wide': ' Wide Range', 'Neutral': ' Neutral'};
                return labels[grp] || grp;
            }
            if (mode === 'growth') {
                const labels = {'Fast': ' Fast Growth', 'Medium': ' Medium Growth', 'Slow': ' Slow Growth', 'Unknown': ' Unknown'};
                return labels[grp] || grp;
            }
            if (mode === 'family') {
                return ` ${grp}`;
            }
            return String(grp);
        }

        function getGroupColor(grp, mode) {
            if (mode === 'edibility') {
                const colors = {0: '#e74c3c', 1: '#e67e22', 2: '#f1c40f', 3: '#a2d9ce', 4: '#27ae60', 5: '#2ecc71'};
                return colors[grp] || '#95a5a6';
            }
            if (mode === 'ph') {
                const colors = {'Acid': '#e74c3c', 'Base': '#3498db', 'Wide': '#9b59b6', 'Neutral': '#95a5a6'};
                return colors[grp] || '#95a5a6';
            }
            if (mode === 'growth') {
                const colors = {'Fast': '#2ecc71', 'Medium': '#f1c40f', 'Slow': '#e74c3c', 'Unknown': '#95a5a6'};
                return colors[grp] || '#95a5a6';
            }
            if (mode === 'family') {
                // Hash-based color
                let hash = 0;
                const str = String(grp);
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
                return '#' + "00000".substring(0, 6 - c.length) + c;
            }
            return '#6b9e3e';
        }

        function getPlantColor(d, mode) {
            if (mode === 'edibility') {
                const e = d.Edibility || 0;
                if (e >= 5) return '#2ecc71'; // Green (Excellent)
                if (e >= 4) return '#a2d9ce'; // Teal
                if (e >= 3) return '#f1c40f'; // Yellow
                if (e >= 2) return '#e67e22'; // Orange
                return '#e74c3c'; // Red (Not edible/Low)
            }
            if (mode === 'ph') {
                const ph = (d.pH || '').toLowerCase();
                if (ph.includes('acid') && ph.includes('basic')) return '#9b59b6'; // Purple (Wide)
                if (ph.includes('acid')) return '#e74c3c'; // Red (Acid)
                if (ph.includes('basic') || ph.includes('alkaline')) return '#3498db'; // Blue (Base)
                return '#95a5a6'; // Gray (Neutral/Unknown)
            }
            if (mode === 'growth') {
                if (d.GrowthRate === 'Fast') return '#2ecc71';
                if (d.GrowthRate === 'Slow') return '#e74c3c';
                return '#f1c40f'; // Medium
            }
            if (mode === 'family') {
                // Simple hash for color
                let hash = 0;
                const str = d.Family || 'Unknown';
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
                return '#' + "00000".substring(0, 6 - c.length) + c;
            }
            return '#6b9e3e'; // Default
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            
            let imgHtml = '';
            if (d.hasImage) {
                imgHtml = `<div style="width:100%; height:120px; background:url('${d['Image URL']}') center/cover no-repeat; border-radius:4px; margin-bottom:8px;"></div>`;
            }

            tooltip.innerHTML = `
                ${imgHtml}
                <h4>${d.CommonName}</h4>
                <p><i>${d.Genus} ${d.Species}</i></p>
                <p>Height: ${d.Height || '?'} m</p>
                <p>Zone: ${d.HardinessZones || '?'}</p>
                <p>Edibility: ${d.Edibility || 0}/5</p>
                <p style="font-size:0.8rem; margin-top:5px; color:#888;">Click to view details</p>
            `;
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }

        function resetFilters() {
            document.getElementById('searchFilter').value = '';
            document.getElementById('familyFilter').value = '';
            document.getElementById('growthFilter').value = '';
            document.getElementById('edibilityFilter').value = '0';
            
            // Reset Slider
            document.getElementById('heightMin').value = 0;
            document.getElementById('heightMax').value = 50;
            updateHeightSlider();

            // Reset Zone
            selectedZone = null;
            toggleZone(null); // This will clear it
            
            applyFilters();
        }

        function toggleList() {
            const panel = document.getElementById('listPanel');
            panel.classList.toggle('open');
            const btn = document.querySelector('.list-toggle');
            btn.innerHTML = panel.classList.contains('open') ? 
                '<i class="fas fa-chevron-down"></i> Hide List' : 
                '<i class="fas fa-list"></i> Show List View';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('open');
            } else {
                sidebar.classList.toggle('collapsed');
                // Trigger resize for D3
                setTimeout(onWindowResize, 350);
            }
        }

        function updateList() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            
            filteredData.slice(0, 50).forEach(d => {
                const tr = document.createElement('tr');
                const imgHtml = d.hasImage ? 
                    `<img src="${d['Image URL']}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">` : 
                    `<div style="width:30px; height:30px; border-radius:50%; background:#eee; display:flex; align-items:center; justify-content:center; font-size:0.7rem;">?</div>`;
                
                tr.innerHTML = `
                    <td>${imgHtml}</td>
                    <td>${d.CommonName}</td>
                    <td><i>${d.Genus} ${d.Species}</i></td>
                    <td>${d.Family}</td>
                    <td>${d.Height || '-'}</td>
                    <td>${d.HardinessZones}</td>
                `;
                tr.onclick = () => {
                    if(d.PFAF) window.open(d.PFAF, '_blank');
                };
                tbody.appendChild(tr);
            });
        }

        // Start
        init();

    </script>
</body>
</html>
